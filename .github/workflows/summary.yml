name: Summary CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  summary:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Collect workflow statuses
        id: collect
        run: |
          ci_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ci_url=$ci_url" >> $GITHUB_OUTPUT
          echo "ci_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT

          # Helper to fetch status and url from API
          fetch_status () {
            wf_file=$1
            runs=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/actions/workflows/$wf_file/runs?branch=main&per_page=1")
            status=$(echo "$runs" | jq -r '.workflow_runs[0].conclusion // "unknown"')
            url=$(echo "$runs" | jq -r '.workflow_runs[0].html_url // "unknown"')
            echo "$status;$url"
          }

          IFS=';' read lh_status lh_url <<< "$(fetch_status lighthouse_api_fixed.yml)"
          IFS=';' read sec_status sec_url <<< "$(fetch_status security.yml)"

          echo "lighthouse_status=$lh_status" >> $GITHUB_OUTPUT
          echo "lighthouse_url=$lh_url" >> $GITHUB_OUTPUT
          echo "security_status=$sec_status" >> $GITHUB_OUTPUT
          echo "security_url=$sec_url" >> $GITHUB_OUTPUT

      - name: Comment summary on PR
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (pr) {
              const ciStatus = "${{ steps.collect.outputs.ci_status }}";
              const ciUrl = "${{ steps.collect.outputs.ci_url }}";
              const lhStatus = "${{ steps.collect.outputs.lighthouse_status }}";
              const lhUrl = "${{ steps.collect.outputs.lighthouse_url }}";
              const secStatus = "${{ steps.collect.outputs.security_status }}";
              const secUrl = "${{ steps.collect.outputs.security_url }}";

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `üìä **Workflow Summary**\n\n- ‚úÖ CI: **${ciStatus}** ‚Üí [Run](${ciUrl})\n- üîé Lighthouse: **${lhStatus}** ‚Üí [Results](${lhUrl})\n- üõ°Ô∏è Security: **${secStatus}** ‚Üí [Results](${secUrl})`
              });
            }
