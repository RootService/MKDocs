name: Summary CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  summary:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Collect workflow statuses
        id: collect
        run: |
          ci_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ci_url=$ci_url" >> $GITHUB_OUTPUT
          echo "ci_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT

          for wf in lighthouse.yml security.yml; do
            runs=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "${{ github.api_url }}/repos/${{ github.repository }}/actions/workflows/$wf/runs?branch=main&per_page=1")
            status=$(echo "$runs" | jq -r '.workflow_runs[0].conclusion // "unknown"')
            url=$(echo "$runs" | jq -r '.workflow_runs[0].html_url // "unknown"')
            echo "${wf}_status=$status" >> $GITHUB_OUTPUT
            echo "${wf}_url=$url" >> $GITHUB_OUTPUT
          done

      - name: Comment summary on PR
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (pr) {
              const ciStatus = "${{ steps.collect.outputs.ci_status }}";
              const ciUrl = "${{ steps.collect.outputs.ci_url }}";
              const lighthouseStatus = "${{ steps.collect.outputs.lighthouse.yml_status }}";
              const lighthouseUrl = "${{ steps.collect.outputs.lighthouse.yml_url }}";
              const securityStatus = "${{ steps.collect.outputs.security.yml_status }}";
              const securityUrl = "${{ steps.collect.outputs.security.yml_url }}";

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ğŸ“Š **Workflow Summary**\n\n- âœ… CI: **${ciStatus}** â†’ [View Run](${ciUrl})\n- ğŸ” Lighthouse: **${lighthouseStatus}** â†’ [Results](${lighthouseUrl})\n- ğŸ›¡ï¸ Security: **${securityStatus}** â†’ [Results](${securityUrl})`
              });
            }
