name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  name: mkdocs
  CI: true
  LOG_TAIL_LINES: 500
  TAG_PREFIX: RootService/MKDocs
  CHROME_PATH: /usr/bin/google-chrome
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
#  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      mkdocs_status: ${{ steps.mkdocs_summary.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - run: |
          sudo apt-get update
          sudo apt-get install -y libavif-bin librsvg2-bin webp zip

      - name: Configure Git Credentials
        run: |
          git config --global init.defaultBranch main
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          check-latest: true
          cache: 'pip'

      - run: |
          echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install --upgrade -r requirements.txt; fi
          pip install --upgrade mkdocs mkdocs-material

      - name: Lint Markdown (markdownlint-cli2)
        continue-on-error: true
        run: |
          if [ -f .markdownlint-cli2.jsonc ]; then cfg=".markdownlint-cli2.jsonc"; else cfg=""; fi
          if [ -n "$cfg" ]; then
            npx --yes markdownlint-cli2 --config "$cfg"
          else
            return 1
          fi

      - name: Build renditions (PNG/WebP/AVIF)
        continue-on-error: true
        run: |
          mkdir -p build/img
          find docs assets overrides -name '*.svg' -print0 | while IFS= read -r -d '' f; do
            WIDTHS="64 128 256 512 1024 2048"
            for w in $WIDTHS; do
              rsvg-convert -w "$w" "$f" -o "build/img/$(basename "${f%.svg}")_${w}.png"
              cwebp -quiet -lossless "build/img/$(basename "${f%.svg}")_${w}.png" -o "build/img/$(basename "${f%.svg}")_${w}.webp"
              avifenc --yuv 444 --depth 8 --speed 6 --min 0 --max 0 "build/img/$(basename "${f%.svg}")_${w}.png" "build/img/$(basename "${f%.svg}")_${w}.avif"
            done
          done
          mkdir -p docs/assets
          cp -r build/img/* docs/assets/
          ts=$(date -u +%Y%m%dT%H%M%SZ)
          ZIP="rootservice_renditions_${ts}.zip"
          zip -qr "$ZIP" docs/assets
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"

      - name: Upload ZIP artifact
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP }}
          path: ${{ env.ZIP }}
          if-no-files-found: error
          retention-days: 14

      - name: Commit assets to repo (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          git add docs/assets/*.{png,webp,avif} || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(images): add AVIF/WebP/PNG renditions (64..2048)"
            git push || true
          fi

      - name: Build site
        id: mkdocs_build
        run: |
          if [ -f mkdocs.yml ]; then
            mkdocs build --clean 2>&1 | tee build.log
            build_rc=${PIPESTATUS[0]}
            if [ $build_rc -eq 0 ]; then
              mkdocs gh-deploy --force 2>&1 | tee deploy.log
            fi
            exit $build_rc
          else
            echo "mkdocs.yml missing"; exit 1
          fi

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site
          if-no-files-found: error
          retention-days: 5
          include-hidden-files: true

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
          retention-days: 5
          include-hidden-files: true

      - name: Upload deploy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log
          if-no-files-found: warn
          retention-days: 5
          include-hidden-files: true

      - name: Extract last log lines
        if: failure() && hashFiles('build.log') != ''
        id: log_tail
        run: |
          echo "============================="  > log_tail.txt
          echo "======== build.log ==========" >> log_tail.txt
          echo "=============================" >> log_tail.txt
          [ -f build.log ] && tail -n "$LOG_TAIL_LINES" build.log >> log_tail.txt || true
          tail -n "$LOG_TAIL_LINES" build.log  >> log_tail.txt
          echo "=============================" >> log_tail.txt
          echo "======== deploy.log =========" >> log_tail.txt
          echo "=============================" >> log_tail.txt
          [ -f deploy.log ] && tail -n "$LOG_TAIL_LINES" deploy.log >> log_tail.txt || true
          {
            echo 'log<<EOF'
            cat log_tail.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: MkDocs summary
        id: mkdocs_summary
        if: always()
        run: |
          if [ -f site/index.html ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment MkDocs result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          result-encoding: string
          retries: 3
          script: |
            const status = `${{ steps.mkdocs_summary.outputs.status }}`;
            const runId = `${{ github.run_id }}`;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            let body = `📖 MkDocs Build status: **${status}**\n\n📦 [Artifacts](${artifactUrl})`;
            if (status === "failure" && `${{ steps.log_tail.outputs.log }}`) {
              body += `\n\n🚨 Build Log (last ${{ env.LOG_TAIL_LINES }} lines):\n\n\\`\\`\\`\n${{ steps.log_tail.outputs.log }}\n\\`\\`\\``;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  lighthouse:
    needs: build
    continue-on-error: true
    # läuft auf PRs und auf main-Pushes
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      performance: ${{ steps.scores.outputs.performance }}
      accessibility: ${{ steps.scores.outputs.accessibility }}
      bestPractices: ${{ steps.scores.outputs.bestPractices }}
      seo: ${{ steps.scores.outputs.seo }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: '24'
          check-latest: true
          cache: 'npm'

      - name: Install Node.js deps (if present)
        if: ${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != '' || hashFiles('package.json') != '' }}
        run: |
          npm install --no-audit --no-fund

      - name: Download site artifact
        uses: actions/download-artifact@v5
        with:
          name: site
          path: site

      - name: Ensure LHCI config files
        run: |
          test -f .lighthouserc.json || echo "⚠ Missing .lighthouserc.json (softfail)" || true
          test -f .desktopConfig.json || echo "⚠ Missing .desktopConfig.json (softfail)" || true

      - name: Serve site
        run: |
          npx http-server ./site -p 8000 &
          echo $! > httpserver.pid
          sleep 2
#          npx --yes serve ./site --listen tcp://0.0.0.0:8000 --single --no-clipboard > server.log 2>&1 &
#          npx --yes wait-on http://localhost:8000 --timeout 60000

      - name: Run Lighthouse CI
        continue-on-error: true
        env:
          LHCI_BUILD_CONTEXT__CURRENT_HASH: github-actions
        run: |
          if [ -f .lighthouserc.json ]; then cfg=".lighthouserc.json"; else cfg=""; fi
          if [ -n "$cfg" ]; then
            npx --yes lhci autorun --rc-file "$cfg"
          else
            npx --yes lhci autorun --collect.staticDistDir=./site --collect.url=http://localhost:8000/
          fi

      - name: Stop server
        if: always()
        run: |
          if [ -f httpserver.pid ]; then kill $(cat httpserver.pid) || true; fi

      - name: Validate LHCI output (must NOT be empty)
        run: |
          if [ -z "$(ls -A .lighthouseci 2>/dev/null)" ]; then
            echo "No LHCI output generated"; exit 1
          fi

      - name: Extract Scores
        id: scores
        if: ${{ hashFiles('.lighthouseci/manifest.json') != '' }}
        run: |
          extract_score() {
            key=$1
            score=$(jq -r ".[0].summary.${key}" .lighthouseci/manifest.json)
            percent=$(awk "BEGIN {printf \"%.0f\", $score * 100}")
            echo "${key}=$percent" >> "$GITHUB_OUTPUT"
          }
          extract_score performance
          extract_score accessibility
          extract_score bestPractices
          extract_score seo

      - name: Upload Lighthouse report
        if: ${{ hashFiles('.lighthouseci/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          if-no-files-found: error
          retention-days: 5
          include-hidden-files: true

      - name: Comment Lighthouse result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          result-encoding: string
          retries: 3
          script: |
            const runId = context.runId;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `🔎 Lighthouse CI completed\n\n📦 [Artifacts](${artifactUrl})`
            });

  security:
    needs: build
    continue-on-error: true
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

      - name: Comment result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          result-encoding: string
          retries: 3
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "🛡️ Security check completed: dependency review run."
            });

  summary:
    needs: [build, lighthouse]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate CI Summary
        run: |
          echo "## CI Pipeline Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- MkDocs: ${{ needs.build.outputs.mkdocs_status }}" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${{ needs.lighthouse.outputs.performance }}" ]; then
            echo "### Lighthouse Scores" >> "$GITHUB_STEP_SUMMARY"
            echo "- Performance: ${{ needs.lighthouse.outputs.performance }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- Accessibility: ${{ needs.lighthouse.outputs.accessibility }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- Best Practices: ${{ needs.lighthouse.outputs.bestPractices }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- SEO: ${{ needs.lighthouse.outputs.seo }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### Lighthouse Scores" >> "$GITHUB_STEP_SUMMARY"
            echo "No Lighthouse results found." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "- https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Comment CI Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          result-encoding: string
          retries: 3
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const mk = `${{ needs.build.outputs.mkdocs_status }}`;
            const perf = `${{ needs.lighthouse.outputs.performance }}`;
            const a11y = `${{ needs.lighthouse.outputs.accessibility }}`;
            const bp = `${{ needs.lighthouse.outputs.bestPractices }}`;
            const seo = `${{ needs.lighthouse.outputs.seo }}`;
            const lines = [
              "## CI Pipeline Summary",
              `- MkDocs: **${mk || 'n/a'}**`,
              "### Lighthouse",
              `- Performance: **${perf || 'n/a'}**`,
              `- Accessibility: **${a11y || 'n/a'}**`,
              `- Best Practices: **${bp || 'n/a'}**`,
              `- SEO: **${seo || 'n/a'}**`,
              "",
              "### Artifacts",
              `- ${runUrl}`
            ];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            });
